<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!--Bootstrap CSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="exercici_estacions.css" type="text/css"/>
    <style type = "text/css">
    </style>
    <title>Document</title>

</head>
<body class = "px-0">
    <div class = "container-fluid p-0 text-center text-white" id = "header">
        <img  src = "imagenes/bikes_bcn.jpg" class = "img-fluid" id = "portada"/>
        <h1 class = "mb-4">Estacions de bicicletes: BCN</h1>
    </div>
    
    <div class = "interaccio">
        <input type = "button" value = "Carregar Dades" class = "btn btn-primary" id = "carregar">
        <svg id = "fletxa" viewBox="0 0 16 16" class="bi bi-arrow-down-circle-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
        </svg>
    </div>
    <div class = "container mt-5" id = "main_container">
        <div class = "row" id = "capa_resultat"></div>
    </div>    

    <!--JQuery and Bootstrap Bundle (includes Popper)-->
    <script src="http://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script language= "javascript">
        $(document).ready(function(){
            $("#fletxa").hide();

            $("#carregar").click(function(){
                $.get("https://api.bsmsa.eu/ext/api/bsm/gbfs/v2/en/station_status",function(data,status){
                    var estacions = data.data.stations;
                    var estacio = "";
                    var etiqueta_estacio = "";
                    var i = 0;
                    for(i = 0; i < 4; i++){
                        estacio = estacions[i];
                        etiqueta_estacio = generacio_etiqueta(estacio);
                        $("#capa_resultat").append(etiqueta_estacio);
                        complete_circle_bar_info(estacio);
                    }
                });
            });


            /*--------------------------Generació d'una etiqueta---------------------------*/
            function generacio_etiqueta(info_estacio){
                //Captació dades
                var stacio_id = info_estacio.station_id;
                var total_bicicletes = info_estacio.num_docks_available;
                var bicicletes_disponibles = info_estacio.num_bikes_available;
                var bic_electriques = info_estacio.num_bikes_available_types.ebike;
                var bic_mecaniques = info_estacio.num_bikes_available_types.mechanical;
                var disponibilitat = 0;
                //Processos estadístics
                if(total_bicicletes==0)disponibilitat = 0;
                else disponibilitat = Math.floor((bicicletes_disponibles/total_bicicletes)*100);
                

                var etiqueta = 
                "<!--Primera card-->"
                +"<div class = 'col col-6'>"
                    +"<!--Contingut Targeta-->"
                    +"<div class = 'card bg-light my-3'>"
                        +"<div class = 'row'>"
                            +"<div class = 'col col-3 card-title'><h2 class = 'text-center'>"+stacio_id+"</h2></div>"
                            +"<div class = 'col col-9 card-body'>"
                                +"<div class='row'>"
                                    +"<div class='col col-md-7 col-xl-6 offset-xl-1 disp'><span>Disponibilitat: "+bicicletes_disponibles+"/"+total_bicicletes+"</span></div>"
                                    +"<div class='col col-md-5 col-xl-5 circle_bar'>"
                                        +"<!--Gràfica Rodona-->"
                                        +"<div class='progress mx-auto' data-value='80' id = 'circle"+stacio_id+"'>"
                                            +"<span class='progress-left'>"
                                                        +"<span class='progress-bar border-primary'></span>"
                                            +"</span>"
                                            +"<span class='progress-right'>"
                                                        +"<span class='progress-bar border-primary'></span>"
                                            +"</span>"
                                            +"<div class='progress-value w-100 h-100 rounded-circle d-flex align-items-center justify-content-center'>"
                                            +"<p class='mt-3 font-weight-bold'>"+disponibilitat+"<sup class='small'>%</sup></p>"
                                            +"</div>"
                                        +"</div>"
                                        +"<!--Fi Gràfica Rodona-->"
                                    +"</div>"
                                +"</div>"
                                +"<div class='row'>"
                                    +"<div class='col offset-1 col-3 icon'>"
                                        +"<svg viewBox='0 0 16 16' class='bi bi-gear-fill' fill='currentColor' xmlns='http://www.w3.org/2000/svg'>"
                                            +"<path fill-rule='evenodd' d='M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 0 0-5.86 2.929 2.929 0 0 0 0 5.858z'/>"
                                        +"</svg>"
                                    +"</div>"
                                    +"<div class='col col-8 capa_progres'>"
                                        +"<!--Barra progrés-->"
                                        +"<div class='progress'>"
                                            +"<div id = 'mecbar"+stacio_id+"' class='progress-bar' role='progressbar' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100' style='width:70%'>"+bic_mecaniques+"/"+bicicletes_disponibles+"</div>"
                                        +"</div>"
                                        +"<!--Fi barra progrés-->"
                                    +"</div>"
                                +"</div>"
                                +"<div class='row'>"
                                    +"<div class='col offset-1 col-3 icon'>"
                                        +"<svg viewBox='0 0 16 16' class='bi bi-plug-fill' fill='currentColor' xmlns='http://www.w3.org/2000/svg'>"
                                            +"<path fill-rule='evenodd' d='M6 0a.5.5 0 0 1 .5.5V3h3V.5a.5.5 0 0 1 1 0V3h1a.5.5 0 0 1 .5.5v3A3.5 3.5 0 0 1 8.5 10c-.002.434-.01.845-.04 1.22-.041.514-.126 1.003-.317 1.424a2.083 2.083 0 0 1-.97 1.028C6.725 13.9 6.169 14 5.5 14c-.998 0-1.61.33-1.974.718A1.922 1.922 0 0 0 3 16H2c0-.616.232-1.367.797-1.968C3.374 13.42 4.261 13 5.5 13c.581 0 .962-.088 1.218-.219.241-.123.4-.3.514-.55.121-.266.193-.621.23-1.09.027-.34.035-.718.037-1.141A3.5 3.5 0 0 1 4 6.5v-3a.5.5 0 0 1 .5-.5h1V.5A.5.5 0 0 1 6 0z'/>"
                                        +"</svg>"
                                    +"</div>"
                                    +"<div class='col col-8 capa_progres'>"
                                        +"<!--Barra progrés-->"
                                        +"<div class='progress'>"
                                            +"<div id = 'ebar"+stacio_id+"' class='progress-bar' role='progressbar' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100' style='width:70%'>"+bic_electriques+"/"+bicicletes_disponibles+"</div>"
                                        +"</div>"
                                    +"</div>"
                                +"</div>"
                            +"</div>"
                        +"</div>"
                    +"</div>"
                +"</div>"
                +"<!--Fi de la primera card-->";
                return etiqueta;
            }

            /*--------------------------Programació de la Circle Bar----------------------*/
            function complete_circle_bar_info(info_estacio){
                //Captació informació
                var stacio_id = info_estacio.station_id;
                var total_bicicletes = info_estacio.num_docks_available;
                var bicicletes_disponibles = info_estacio.num_bikes_available;
                var bic_electriques = info_estacio.num_bikes_available_types.ebike;
                var bic_mecaniques = info_estacio.num_bikes_available_types.mechanical;

                //Processos Estadístics
                var disponibilitat = 0;
                if(total_bicicletes==0)disponibilitat = 0;
                else disponibilitat = Math.floor((bicicletes_disponibles/total_bicicletes)*100);

                var percentatge_ebike = Math.floor((bic_electriques/bicicletes_disponibles)*100);
                var percentatge_mecbike = Math.floor((bic_mecaniques/bicicletes_disponibles)*100); 

                //Ajustem valors del circlebar
                var value = disponibilitat;
                var left = $(".progress").find('.progress-left .progress-bar');
                var right = $(".progress").find('.progress-right .progress-bar');
                if (value > 0) {
                    if (value <= 50) {
                        right.css('transform', 'rotate(' + percentageToDegrees(value) + 'deg)')
                    } 
                    else {
                        right.css('transform', 'rotate(180deg)')
                        left.css('transform', 'rotate(' + percentageToDegrees(value - 50) + 'deg)')
                    }
                }
                //Ajustem paràmetres del normalbar
                $("#mecbar"+stacio_id).attr("aria-valuenow",percentatge_mecbike);
                $("#mecbar"+stacio_id).attr("style","width:"+percentatge_mecbike+"%");
                $("#ebar"+stacio_id).attr("aria-valuenow",percentatge_ebike);
                $("#ebar"+stacio_id).attr("style","width:"+percentatge_ebike+"%");
            }

            function percentageToDegrees(percentage) {
                return percentage / 100 * 360;
            }
        });
    </script>
</body>
</html>